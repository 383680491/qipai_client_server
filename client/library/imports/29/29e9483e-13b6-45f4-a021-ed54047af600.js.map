{"version":3,"sources":["..\\..\\..\\..\\assets\\scripts/assets\\scripts\\HotUpdate.js"],"names":["cc","Class","extends","Component","properties","panel","Label","manifestUrl","RawAsset","_updating","_canRetry","_storagePath","regeng","Node","checkCb","event","log","getEventCode","jsb","EventAssetsManager","ERROR_NO_LOCAL_MANIFEST","string","director","loadScene","ERROR_DOWNLOAD_MANIFEST","ERROR_PARSE_MANIFEST","ALREADY_UP_TO_DATE","active","NEW_VERSION_FOUND","btnOk","find","eventManager","removeListener","_checkListener","updateCb","needRestart","failed","UPDATE_PROGRESSION","msg","getMessage","UPDATE_FINISHED","UPDATE_FAILED","ERROR_UPDATING","getAssetId","ERROR_DECOMPRESS","_updateListener","searchPaths","fileUtils","getSearchPaths","newPaths","_am","getLocalManifest","Array","prototype","unshift","sys","localStorage","setItem","JSON","stringify","setSearchPaths","audioEngine","stopAll","game","restart","retry","downloadFailedAssets","checkUpdate","getState","AssetsManager","State","UNINITED","loadLocalManifest","isLoaded","EventListenerAssetsManager","bind","addListener","hotUpdate","_failCount","update","onLoad","isNative","isMobile","cvs","node","getComponent","Canvas","fitHeight","fitWidth","getWritablePath","versionCompareHandle","versionA","versionB","vA","split","vB","i","length","a","parseInt","b","ENABLE_GC_FOR_NATIVE_OBJECTS","retain","setVerifyCallback","path","asset","compressed","expectedMD5","md5","relativePath","size","os","OS_ANDROID","setMaxConcurrentTask","onDestroy","release"],"mappings":"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","file":"HotUpdate.js","sourceRoot":"..\\..\\..\\..\\assets\\scripts","sourcesContent":["cc.Class({\r\n    extends: cc.Component,\r\n\r\n    properties: {\r\n        panel: cc.Label,\r\n        manifestUrl: cc.RawAsset,\r\n        //fileProgress: cc.ProgressBar,\r\n        //byteProgress: cc.ProgressBar,\r\n        _updating: false,\r\n        _canRetry: false,\r\n        _storagePath: '',\r\n        regeng:cc.Node\r\n    },\r\n\r\n    checkCb: function (event) {\r\n        cc.log('Code: ' + event.getEventCode());\r\n        switch (event.getEventCode())\r\n        {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                this.panel.string = \"没有当地的清单文件发现,热更新跳过.\";\r\n                cc.director.loadScene(\"start\");\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n                cc.director.loadScene(\"start\");\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                this.panel.string = \"无法下载清单文件,热更新跳过.\";\r\n                cc.director.loadScene(\"start\");\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                this.panel.string = \"已经更新了最新的远程版本.\";\r\n                this.regeng.active = false;\r\n                cc.director.loadScene(\"start\");\r\n                break;\r\n            case jsb.EventAssetsManager.NEW_VERSION_FOUND:\r\n                this.panel.string = \"检测到更新，请更新...\";\r\n                var btnOk = cc.find(\"Canvas/HotUpDate/ok\");\r\n                btnOk.active = true;\r\n                break;\r\n            default:\r\n                return;\r\n        }\r\n        cc.eventManager.removeListener(this._checkListener);\r\n        this._checkListener = null;\r\n        this._updating = false;\r\n    },\r\n\r\n    updateCb: function (event) {\r\n        var needRestart = false;\r\n        var failed = false;\r\n        switch (event.getEventCode())\r\n        {\r\n            case jsb.EventAssetsManager.ERROR_NO_LOCAL_MANIFEST:\r\n                //this.panel.string = '没有当地的清单文件发现,热更新跳过.';\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_PROGRESSION:\r\n                //this.byteProgress.progress = event.getPercent();\r\n                //this.fileProgress.progress = event.getPercentByFile();\r\n\r\n                //this.panel.fileLabel.string = event.getDownloadedFiles() + ' / ' + event.getTotalFiles();\r\n                //this.panel.byteLabel.string = event.getDownloadedBytes() + ' / ' + event.getTotalBytes();\r\n\r\n                var msg = event.getMessage();\r\n                if (msg) {\r\n                    //this.panel.string = '更新后的文件: ' + msg;\r\n                    // cc.log(event.getPercent()/100 + '% : ' + msg);\r\n                }\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DOWNLOAD_MANIFEST:\r\n            case jsb.EventAssetsManager.ERROR_PARSE_MANIFEST:\r\n                this.panel.string = '无法下载清单文件,热更新跳过.';\r\n                failed = true;\r\n                break;\r\n            case jsb.EventAssetsManager.ALREADY_UP_TO_DATE:\r\n                this.panel.string = '已经更新了最新的远程版本.';\r\n                failed = true;\r\n                this.regeng.active = false;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FINISHED:\r\n                this.panel.string = '更新完成了. ' + event.getMessage();\r\n                needRestart = true;\r\n                break;\r\n            case jsb.EventAssetsManager.UPDATE_FAILED:\r\n                this.panel.string = '更新失败. ' + event.getMessage();\r\n                //this.panel.retryBtn.active = true;\r\n                this._updating = false;\r\n                this._canRetry = true;\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_UPDATING:\r\n                this.panel.string = '资产更新错误: ' + event.getAssetId() + ', ' + event.getMessage();\r\n                break;\r\n            case jsb.EventAssetsManager.ERROR_DECOMPRESS:\r\n                this.panel.string = event.getMessage();\r\n                break;\r\n            default:\r\n                break;\r\n        }\r\n\r\n        if (failed) {\r\n            cc.eventManager.removeListener(this._updateListener);\r\n            this._updateListener = null;\r\n            this._updating = false;\r\n        }\r\n\r\n        if (needRestart) {\r\n            cc.eventManager.removeListener(this._updateListener);\r\n            this._updateListener = null;\r\n            // Prepend the manifest's search path\r\n            var searchPaths = jsb.fileUtils.getSearchPaths();\r\n            var newPaths = this._am.getLocalManifest().getSearchPaths();\r\n         //   console.log(JSON.stringify(newPaths));\r\n            Array.prototype.unshift(searchPaths, newPaths);\r\n            // This value will be retrieved and appended to the default search path during game startup,\r\n            // please refer to samples/js-tests/main.js for detailed usage.\r\n            // !!! Re-add the search paths in main.js is very important, otherwise, new scripts won't take effect.\r\n            cc.sys.localStorage.setItem('HotUpdateSearchPaths', JSON.stringify(searchPaths));\r\n            jsb.fileUtils.setSearchPaths(searchPaths);\r\n\r\n            cc.audioEngine.stopAll();\r\n            cc.game.restart();\r\n        }\r\n    },\r\n\r\n    // loadCustomManifest: function () {\r\n    //     if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n    //         var manifest = new jsb.Manifest(customManifestStr, this._storagePath);\r\n    //         this._am.loadLocalManifest(manifest, this._storagePath);\r\n    //         this.panel.string = 'Using custom manifest';\r\n    //     }\r\n    // },\r\n    \r\n    retry: function () {\r\n        if (!this._updating && this._canRetry) {\r\n            this._canRetry = false;\r\n            \r\n            //this.panel.string = 'Retry failed Assets...';\r\n            this._am.downloadFailedAssets();\r\n        }\r\n    },\r\n    \r\n    checkUpdate: function () {\r\n        if (this._updating) {\r\n            this.panel.string = '检查或更新 ...';\r\n            return;\r\n        }\r\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n            this._am.loadLocalManifest(this.manifestUrl);\r\n        }\r\n        if (!this._am.getLocalManifest() || !this._am.getLocalManifest().isLoaded()) {\r\n            this.panel.string = '未能加载本地清单 ...';\r\n            return;\r\n        }\r\n        this._checkListener = new jsb.EventListenerAssetsManager(this._am, this.checkCb.bind(this));\r\n        cc.eventManager.addListener(this._checkListener, 1);\r\n\r\n        this._am.checkUpdate();\r\n        this._updating = true;\r\n    },\r\n\r\n    hotUpdate: function () {\r\n        if (this._am && !this._updating) {\r\n            this._updateListener = new jsb.EventListenerAssetsManager(this._am, this.updateCb.bind(this));\r\n            cc.eventManager.addListener(this._updateListener, 1);\r\n\r\n            if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n                this._am.loadLocalManifest(this.manifestUrl);\r\n            }\r\n\r\n            this._failCount = 0;\r\n            this._am.update();\r\n            this._updating = true;\r\n        }\r\n        var btnOk = cc.find(\"Canvas/HotUpDate/ok\");\r\n        btnOk.active = false;\r\n    },\r\n\r\n    onLoad: function () {\r\n        if(!cc.sys.isNative && cc.sys.isMobile){\r\n            var cvs = this.node.getComponent(cc.Canvas);\r\n            cvs.fitHeight = true;\r\n            cvs.fitWidth = true;\r\n        }\r\n        if (!cc.sys.isNative) {\r\n            return;\r\n        }\r\n        this._storagePath = ((jsb.fileUtils ? jsb.fileUtils.getWritablePath() : '/') + 'blackjack-remote-asset');\r\n        cc.log('存储路径为远程资产 : ' + this._storagePath);\r\n        // Setup your own version compare handler, versionA and B is versions in string\r\n        // if the return value greater than 0, versionA is greater than B,\r\n        // if the return value equals 0, versionA equals to B,\r\n        // if the return value smaller than 0, versionA is smaller than B.\r\n        var versionCompareHandle = function (versionA, versionB) {\r\n            cc.log(\"JS Custom Version Compare: version A is \" + versionA + ', version B is ' + versionB);\r\n            var vA = versionA.split('.');\r\n            var vB = versionB.split('.');\r\n            for (var i = 0; i < vA.length; ++i) {\r\n                var a = parseInt(vA[i]);\r\n                var b = parseInt(vB[i] || 0);\r\n                if (a === b) {\r\n                    continue;\r\n                }\r\n                else {\r\n                    return a - b;\r\n                }\r\n            }\r\n            if (vB.length > vA.length) {\r\n                return -1;\r\n            }\r\n            else {\r\n                return 0;\r\n            }\r\n        };\r\n\r\n        // Init with empty manifest url for testing custom manifest\r\n        this._am = new jsb.AssetsManager('', this._storagePath, versionCompareHandle);\r\n        if (!cc.sys.ENABLE_GC_FOR_NATIVE_OBJECTS) {\r\n            this._am.retain();\r\n        }\r\n\r\n        //var panel = this.panel;\r\n        // Setup the verification callback, but we don't have md5 check function yet, so only print some message\r\n        // Return true if the verification passed, otherwise return false\r\n        this._am.setVerifyCallback(function (path, asset) {\r\n            // When asset is compressed, we don't need to check its md5, because zip file have been deleted.\r\n            var compressed = asset.compressed;\r\n            // Retrieve the correct md5 value.\r\n            var expectedMD5 = asset.md5;\r\n            // asset.path is relative path and path is absolute.\r\n            var relativePath = asset.path;\r\n            // The size of asset file, but this value could be absent.\r\n            var size = asset.size;\r\n            if (compressed) {\r\n                //panel.string = \"验证通过了 : \" + relativePath;\r\n                return true;\r\n            }\r\n            else {\r\n                //panel.string = \"验证通过了 : \" + relativePath + ' (' + expectedMD5 + ')';\r\n                return true;\r\n            }\r\n        });\r\n\r\n        if (cc.sys.os === cc.sys.OS_ANDROID) {\r\n            // Some Android device may slow down the download process when concurrent tasks is too much.\r\n            // The value may not be accurate, please do more test and find what's most suitable for your game.\r\n            this._am.setMaxConcurrentTask(2);\r\n            //this.panel.string = \"最大并发任务数仅限于2\";\r\n        }\r\n        //this.fileProgress.progress = 0;\r\n        //this.byteProgress.progress = 0;\r\n        if (this._updating) {\r\n            this.panel.string = '检查或更新 ...';\r\n            return;\r\n        }\r\n        if (this._am.getState() === jsb.AssetsManager.State.UNINITED) {\r\n            this._am.loadLocalManifest(this.manifestUrl);\r\n        }\r\n        if (!this._am.getLocalManifest() || !this._am.getLocalManifest().isLoaded()) {\r\n            this.panel.string = '未能加载本地清单 ...';\r\n            return;\r\n        }\r\n        this._checkListener = new jsb.EventListenerAssetsManager(this._am, this.checkCb.bind(this));\r\n        cc.eventManager.addListener(this._checkListener, 1);\r\n        this._am.checkUpdate();\r\n        this._updating = true;\r\n    },\r\n\r\n    onDestroy: function () {\r\n        if (this._updateListener) {\r\n            cc.eventManager.removeListener(this._updateListener);\r\n            this._updateListener = null;\r\n        }\r\n        if (this._am && !cc.sys.ENABLE_GC_FOR_NATIVE_OBJECTS) {\r\n            this._am.release();\r\n        }\r\n    },\r\n});"]}